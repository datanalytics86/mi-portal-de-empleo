---
import Layout from '../../../../../layouts/Layout.astro';
import Button from '../../../../../components/ui/Button.astro';
import { supabase } from '../../../../../lib/supabase';

// Verificar autenticación
const { cookies, redirect } = Astro;
const accessToken = cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return redirect('/empleador/login');
}

const { data: { user } } = await supabase.auth.getUser(accessToken);

if (!user) {
  return redirect('/empleador/login');
}

const { id } = Astro.params;

if (!id) {
  return redirect('/empleador/dashboard');
}

// Obtener oferta y verificar que pertenece al empleador
const { data: oferta, error: ofertaError } = await supabase
  .from('ofertas')
  .select('*')
  .eq('id', id)
  .eq('empleador_id', user.id)
  .single();

if (ofertaError || !oferta) {
  return redirect('/empleador/dashboard');
}

// Obtener postulaciones
const { data: postulaciones, error: postulacionesError } = await supabase
  .from('postulaciones')
  .select('*')
  .eq('oferta_id', id)
  .order('created_at', { ascending: false });

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('es-CL', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};
---

<Layout title={`Postulaciones - ${oferta.titulo}`}>
  <div class="container mx-auto px-4 sm:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6">
      <a href="/empleador/dashboard" class="text-accent hover:text-accent-hover transition text-sm">
        ← Volver al dashboard
      </a>
    </nav>

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-text-primary">{oferta.titulo}</h1>
      <p class="text-text-secondary mt-2">
        {postulaciones?.length || 0} postulaciones recibidas
      </p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-border">
      {
        postulaciones && postulaciones.length > 0 ? (
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-surface">
                <tr>
                  <th class="text-left px-6 py-3 text-sm font-medium text-text-secondary">
                    Candidato
                  </th>
                  <th class="text-left px-6 py-3 text-sm font-medium text-text-secondary">
                    Email
                  </th>
                  <th class="text-left px-6 py-3 text-sm font-medium text-text-secondary">
                    Fecha
                  </th>
                  <th class="text-left px-6 py-3 text-sm font-medium text-text-secondary">
                    CV
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                {postulaciones.map((postulacion) => (
                  <tr class="hover:bg-surface transition">
                    <td class="px-6 py-4">
                      <p class="font-medium text-text-primary">
                        {postulacion.nombre_candidato || 'Anónimo'}
                      </p>
                    </td>
                    <td class="px-6 py-4 text-sm text-text-secondary">
                      {postulacion.email_candidato || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-text-secondary">
                      {formatDate(postulacion.created_at)}
                    </td>
                    <td class="px-6 py-4">
                      <button
                        class="download-cv text-accent hover:text-accent-hover text-sm font-medium"
                        data-path={postulacion.cv_url}
                      >
                        Descargar CV
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="p-12 text-center">
            <p class="text-text-secondary">Aún no hay postulaciones para esta oferta</p>
          </div>
        )
      }
    </div>
  </div>

  <script>
    import { supabase } from '../../../../../lib/supabase';

    const downloadButtons = document.querySelectorAll('.download-cv');
    downloadButtons.forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const cvPath = button.dataset.path;

        if (!cvPath) return;

        try {
          const { data, error } = await supabase.storage
            .from('cvs')
            .createSignedUrl(cvPath, 60); // URL válida por 60 segundos

          if (error) throw error;

          if (data?.signedUrl) {
            window.open(data.signedUrl, '_blank');
          }
        } catch (error) {
          console.error('Error downloading CV:', error);
          alert('Error al descargar el CV');
        }
      });
    });
  </script>
</Layout>
