---
/**
 * Página principal - Home
 *
 * Muestra mapa interactivo con ofertas de trabajo y lista filtrable
 * Basado en SPECIFICATIONS.md sección 5.1
 */

export const prerender = false;

import Layout from '../layouts/Layout.astro';
import MapaOfertas from '../components/MapaOfertas.astro';
import OfertaCard from '../components/OfertaCard.astro';
import { getOfertasActivas } from '../data/mock-ofertas';
import { findComuna } from '../lib/comunas';

// Obtener ofertas activas desde mock data
const ofertas = getOfertasActivas();

// Transformar ofertas para el mapa (agregar coordenadas lat/lng)
const ofertasConCoordenadas = (ofertas || []).map(oferta => {
  const comuna = findComuna(oferta.comuna);
  return {
    ...oferta,
    lat: comuna?.lat || -33.4489,  // Fallback a Santiago
    lng: comuna?.lng || -70.6693
  };
}).filter(oferta => oferta.lat && oferta.lng);  // Solo ofertas con coordenadas válidas

// Ofertas para el mapa (formato simplificado)
const ofertasParaMapa = ofertasConCoordenadas.map(o => ({
  id: o.id,
  titulo: o.titulo,
  empresa: o.empresa,
  comuna: o.comuna,
  lat: o.lat,
  lng: o.lng
}));

const totalOfertas = ofertas?.length || 0;
---

<Layout>
  <div class="container mx-auto px-4 md:px-8 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-text-primary mb-3">
        Encuentra tu próximo trabajo en Chile
      </h1>
      <p class="text-lg text-text-secondary max-w-2xl mx-auto">
        Explora ofertas laborales georeferenciadas. Postula sin registro, solo sube tu CV.
      </p>
    </div>

    <!-- Barra de búsqueda -->
    <div class="mb-6">
      <div class="max-w-3xl mx-auto">
        <div class="relative">
          <input
            type="text"
            id="search-input"
            placeholder="Buscar por título, empresa o comuna..."
            class="w-full px-4 py-3 pl-12 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
          />
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
          >
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
        </div>
        <p class="text-sm text-text-secondary mt-2 text-center">
          {totalOfertas} ofertas disponibles
        </p>
      </div>
    </div>

    <!-- Mapa -->
    <div class="mb-12">
      {ofertasParaMapa.length > 0 ? (
        <MapaOfertas ofertas={ofertasParaMapa} />
      ) : (
        <div class="h-[400px] md:h-[500px] rounded-lg bg-surface border border-border flex items-center justify-center">
          <p class="text-text-secondary">No hay ofertas para mostrar en el mapa</p>
        </div>
      )}
    </div>

    <!-- Filtros rápidos (próximamente) -->
    <div class="mb-6 flex items-center gap-3 flex-wrap">
      <span class="text-sm font-medium text-text-secondary">Tipo de jornada:</span>
      <button
        class="filter-btn px-3 py-1 rounded-full border border-border text-sm hover:bg-accent hover:text-white hover:border-accent transition"
        data-filter="all"
        data-active="true"
      >
        Todas
      </button>
      <button
        class="filter-btn px-3 py-1 rounded-full border border-border text-sm hover:bg-accent hover:text-white hover:border-accent transition"
        data-filter="Full-time"
      >
        Full-time
      </button>
      <button
        class="filter-btn px-3 py-1 rounded-full border border-border text-sm hover:bg-accent hover:text-white hover:border-accent transition"
        data-filter="Part-time"
      >
        Part-time
      </button>
      <button
        class="filter-btn px-3 py-1 rounded-full border border-border text-sm hover:bg-accent hover:text-white hover:border-accent transition"
        data-filter="Freelance"
      >
        Freelance
      </button>
      <button
        class="filter-btn px-3 py-1 rounded-full border border-border text-sm hover:bg-accent hover:text-white hover:border-accent transition"
        data-filter="Práctica"
      >
        Práctica
      </button>
    </div>

    <!-- Grid de ofertas -->
    {totalOfertas === 0 && (
      <div class="text-center py-12">
        <p class="text-xl text-text-secondary mb-4">
          No hay ofertas disponibles en este momento
        </p>
        <p class="text-text-secondary mb-6">
          ¿Eres empleador? Publica la primera oferta
        </p>
        <a
          href="/empleador/registro"
          class="inline-block px-6 py-3 bg-accent text-white rounded-lg hover:bg-accent-hover transition font-medium"
        >
          Publicar oferta
        </a>
      </div>
    )}

    {totalOfertas > 0 && (
      <div id="ofertas-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {ofertasConCoordenadas.map(oferta => (
          <div
            class="oferta-item"
            data-titulo={oferta.titulo.toLowerCase()}
            data-empresa={oferta.empresa.toLowerCase()}
            data-comuna={oferta.comuna.toLowerCase()}
            data-tipo={oferta.tipo_jornada}
          >
            <OfertaCard
              id={oferta.id}
              titulo={oferta.titulo}
              empresa={oferta.empresa}
              comuna={oferta.comuna}
              tipo_jornada={oferta.tipo_jornada}
              created_at={oferta.created_at}
              descripcion={oferta.descripcion}
            />
          </div>
        ))}
      </div>
    )}

    <!-- Mensaje si no hay resultados filtrados -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-xl text-text-secondary">
        No se encontraron ofertas con esos criterios
      </p>
    </div>

    <!-- Controles de Paginación -->
    {totalOfertas > 9 && (
      <div id="pagination-container" class="flex items-center justify-between mt-8 pt-6 border-t border-border">
        <div class="text-sm text-text-secondary">
          Mostrando <span id="showing-start">1</span> - <span id="showing-end">9</span> de <span id="total-visible">15</span> ofertas
        </div>
        <div class="flex items-center gap-2">
          <button
            id="prev-page"
            class="px-4 py-2 border border-border rounded-lg text-sm font-medium text-text-secondary hover:bg-surface disabled:opacity-50 disabled:cursor-not-allowed transition"
            disabled
          >
            Anterior
          </button>
          <div id="page-numbers" class="flex items-center gap-1"></div>
          <button
            id="next-page"
            class="px-4 py-2 border border-border rounded-lg text-sm font-medium text-text-secondary hover:bg-surface disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            Siguiente
          </button>
        </div>
      </div>
    )}
  </div>
</Layout>

<script>
  // ═══════════════════════════════════════════════════════════════
  // ELEMENTOS DOM
  // ═══════════════════════════════════════════════════════════════
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const ofertasItems = document.querySelectorAll('.oferta-item');
  const noResultsMessage = document.getElementById('no-results');
  const filterButtons = document.querySelectorAll('.filter-btn');

  const paginationContainer = document.getElementById('pagination-container');
  const prevButton = document.getElementById('prev-page') as HTMLButtonElement;
  const nextButton = document.getElementById('next-page') as HTMLButtonElement;
  const pageNumbersContainer = document.getElementById('page-numbers');
  const showingStart = document.getElementById('showing-start');
  const showingEnd = document.getElementById('showing-end');
  const totalVisible = document.getElementById('total-visible');

  // ═══════════════════════════════════════════════════════════════
  // VARIABLES DE ESTADO
  // ═══════════════════════════════════════════════════════════════
  let currentFilter = 'all';
  let currentPage = 1;
  const ITEMS_PER_PAGE = 9;

  // ═══════════════════════════════════════════════════════════════
  // FUNCIÓN PRINCIPAL DE FILTRADO Y PAGINACIÓN
  // ═══════════════════════════════════════════════════════════════
  function filterAndPaginateOfertas() {
    const searchTerm = searchInput?.value.toLowerCase() || '';
    const filteredItems: HTMLElement[] = [];

    // Primero filtrar
    ofertasItems.forEach(item => {
      const titulo = item.getAttribute('data-titulo') || '';
      const empresa = item.getAttribute('data-empresa') || '';
      const comuna = item.getAttribute('data-comuna') || '';
      const tipo = item.getAttribute('data-tipo') || '';

      const matchesSearch =
        titulo.includes(searchTerm) ||
        empresa.includes(searchTerm) ||
        comuna.includes(searchTerm);

      const matchesFilter = currentFilter === 'all' || tipo === currentFilter;

      if (matchesSearch && matchesFilter) {
        filteredItems.push(item as HTMLElement);
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });

    // Calcular paginación
    const totalFiltered = filteredItems.length;
    const totalPages = Math.ceil(totalFiltered / ITEMS_PER_PAGE);

    // Ajustar página actual si es necesario
    if (currentPage > totalPages) {
      currentPage = Math.max(1, totalPages);
    }

    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;

    // Mostrar solo items de la página actual
    filteredItems.forEach((item, index) => {
      if (index >= startIndex && index < endIndex) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });

    // Actualizar UI de paginación
    updatePaginationUI(totalFiltered, totalPages, startIndex, endIndex);

    // Mostrar mensaje si no hay resultados
    if (noResultsMessage) {
      noResultsMessage.style.display = totalFiltered === 0 ? 'block' : 'none';
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // ACTUALIZAR UI DE PAGINACIÓN
  // ═══════════════════════════════════════════════════════════════
  function updatePaginationUI(total: number, totalPages: number, start: number, end: number) {
    if (!paginationContainer) return;

    // Mostrar/ocultar controles de paginación
    if (total <= ITEMS_PER_PAGE) {
      paginationContainer.style.display = 'none';
      return;
    } else {
      paginationContainer.style.display = 'flex';
    }

    // Actualizar texto de contadores
    if (showingStart) showingStart.textContent = (start + 1).toString();
    if (showingEnd) showingEnd.textContent = Math.min(end, total).toString();
    if (totalVisible) totalVisible.textContent = total.toString();

    // Actualizar botones prev/next
    if (prevButton) {
      prevButton.disabled = currentPage === 1;
    }
    if (nextButton) {
      nextButton.disabled = currentPage === totalPages;
    }

    // Generar números de página
    if (pageNumbersContainer) {
      pageNumbersContainer.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i.toString();
        pageButton.className = `px-3 py-1.5 text-sm font-medium rounded transition ${
          i === currentPage
            ? 'bg-accent text-white'
            : 'text-text-secondary hover:bg-surface border border-border'
        }`;
        pageButton.addEventListener('click', () => {
          currentPage = i;
          filterAndPaginateOfertas();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        pageNumbersContainer.appendChild(pageButton);
      }
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // EVENT LISTENERS
  // ═══════════════════════════════════════════════════════════════

  // Búsqueda
  searchInput?.addEventListener('input', () => {
    currentPage = 1; // Reset a primera página
    filterAndPaginateOfertas();
  });

  // Filtros
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Actualizar estado activo
      filterButtons.forEach(btn => {
        btn.removeAttribute('data-active');
        btn.classList.remove('bg-accent', 'text-white', 'border-accent');
      });
      button.setAttribute('data-active', 'true');
      button.classList.add('bg-accent', 'text-white', 'border-accent');

      // Actualizar filtro actual
      currentFilter = button.getAttribute('data-filter') || 'all';
      currentPage = 1; // Reset a primera página
      filterAndPaginateOfertas();
    });
  });

  // Botones de paginación
  prevButton?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      filterAndPaginateOfertas();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  nextButton?.addEventListener('click', () => {
    currentPage++;
    filterAndPaginateOfertas();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Inicializar
  filterAndPaginateOfertas();
</script>

<style>
  /* Estilos para botones de filtro activos */
  .filter-btn[data-active="true"] {
    @apply bg-accent text-white border-accent;
  }
</style>
