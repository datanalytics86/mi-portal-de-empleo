---
/**
 * Componente OfertaCard
 *
 * Tarjeta de oferta de trabajo para listado
 * Basado en SPECIFICATIONS.md sección 6.2
 */

interface Props {
  id: string;
  titulo: string;
  empresa: string;
  comuna: string;
  tipo_jornada: 'Full-time' | 'Part-time' | 'Freelance' | 'Práctica';
  created_at: string;
  descripcion?: string;
}

const { id, titulo, empresa, comuna, tipo_jornada, created_at, descripcion } = Astro.props;

// Calcular fecha relativa
function getRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return 'Hace un momento';
  if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} minutos`;
  if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} horas`;
  if (diffInSeconds < 604800) return `Hace ${Math.floor(diffInSeconds / 86400)} días`;
  if (diffInSeconds < 2592000) return `Hace ${Math.floor(diffInSeconds / 604800)} semanas`;
  return `Hace ${Math.floor(diffInSeconds / 2592000)} meses`;
}

const fechaRelativa = getRelativeTime(created_at);

// Colores para badges de tipo de jornada
const tipoJornadaStyles = {
  'Full-time': 'bg-blue-50 text-blue-700',
  'Part-time': 'bg-green-50 text-green-700',
  'Freelance': 'bg-purple-50 text-purple-700',
  'Práctica': 'bg-orange-50 text-orange-700'
};

const badgeStyle = tipoJornadaStyles[tipo_jornada] || 'bg-gray-50 text-gray-700';
---

<div class="relative bg-white dark:bg-dark-card rounded-lg shadow-sm border border-gray-200 dark:border-dark-border p-6 hover-lift">
  <!-- Botón de favoritos -->
  <button
    class="favorite-btn absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors z-10"
    data-offer-id={id}
    aria-label="Guardar en favoritos"
    title="Guardar en favoritos"
  >
    <svg class="w-6 h-6 text-gray-400 dark:text-dark-text-secondary favorite-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
    </svg>
    <svg class="w-6 h-6 text-red-500 favorite-icon-filled hidden" fill="currentColor" viewBox="0 0 24 24">
      <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"></path>
    </svg>
  </button>

  <!-- Link a detalle (no afecta el botón de favoritos) -->
  <a href={`/oferta/${id}`} class="block">
    <article>
      <!-- Título -->
      <h3 class="text-xl font-semibold text-gray-900 dark:text-dark-text-primary mb-2 line-clamp-2 pr-10">
        {titulo}
      </h3>

      <!-- Empresa -->
      <p class="text-gray-600 dark:text-dark-text-secondary mb-3 font-medium">
        {empresa}
      </p>

      <!-- Comuna y Tipo de Jornada -->
      <div class="flex items-center gap-4 mb-3 flex-wrap">
        <span class="text-sm text-gray-500 dark:text-dark-text-secondary flex items-center gap-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-4 h-4"
            aria-hidden="true"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          {comuna}
        </span>

        <span class={`px-2 py-1 ${badgeStyle} dark:opacity-90 rounded text-xs font-medium`}>
          {tipo_jornada}
        </span>
      </div>

      <!-- Descripción (preview) -->
      {descripcion && (
        <p class="text-sm text-gray-600 dark:text-dark-text-secondary mb-3 line-clamp-2">
          {descripcion}
        </p>
      )}

      <!-- Fecha -->
      <p class="text-sm text-gray-400 dark:text-dark-text-secondary">
        {fechaRelativa}
      </p>
    </article>
  </a>
</div>

<script>
  // Inicializar favoritos para esta card
  document.addEventListener('DOMContentLoaded', () => {
    initializeFavorites();
  });

  function initializeFavorites() {
    const favoriteButtons = document.querySelectorAll('.favorite-btn');

    favoriteButtons.forEach(button => {
      const offerId = button.getAttribute('data-offer-id');
      const iconOutline = button.querySelector('.favorite-icon');
      const iconFilled = button.querySelector('.favorite-icon-filled');

      // Verificar si está en favoritos
      const favorites = JSON.parse(localStorage.getItem('job-favorites') || '[]');
      const isFavorite = favorites.includes(offerId);

      if (isFavorite && iconOutline && iconFilled) {
        iconOutline.classList.add('hidden');
        iconFilled.classList.remove('hidden');
      }

      // Event listener para toggle
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const favorites = JSON.parse(localStorage.getItem('job-favorites') || '[]');
        const index = favorites.indexOf(offerId);

        if (index > -1) {
          // Remover de favoritos
          favorites.splice(index, 1);
          if (iconOutline && iconFilled) {
            iconOutline.classList.remove('hidden');
            iconFilled.classList.add('hidden');
          }
          if (window.toast) {
            window.toast.info('Oferta removida de favoritos');
          }
        } else {
          // Agregar a favoritos
          favorites.push(offerId);
          if (iconOutline && iconFilled) {
            iconOutline.classList.add('hidden');
            iconFilled.classList.remove('hidden');
          }
          if (window.toast) {
            window.toast.success('Oferta guardada en favoritos');
          }
        }

        localStorage.setItem('job-favorites', JSON.stringify(favorites));

        // Disparar evento personalizado para actualizar contador
        window.dispatchEvent(new CustomEvent('favorites-updated', { detail: { count: favorites.length } }));
      });
    });
  }
</script>

<style>
  /* Limitar líneas de texto con ellipsis */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
