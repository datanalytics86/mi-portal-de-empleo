---
interface OfertaMap {
  id: string;
  titulo: string;
  empresa: string;
  lat: number;
  lng: number;
}

interface Props {
  ofertas: OfertaMap[];
}

const { ofertas } = Astro.props;
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<div id="mapa" class="h-[400px] md:h-[500px] rounded-lg shadow-sm border border-border"></div>

<script define:vars={{ ofertas }}>
  // Solo ejecutar en el cliente
  if (typeof window !== 'undefined') {
    import('leaflet').then((L) => {
      const leaflet = L.default;

      // Fix para iconos de Leaflet
      delete leaflet.Icon.Default.prototype._getIconUrl;
      leaflet.Icon.Default.mergeOptions({
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      });

      // Crear mapa centrado en Santiago
      const mapa = leaflet.map('mapa').setView([-33.4489, -70.6693], 12);

      // Añadir capa de tiles
      leaflet.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(mapa);

      // Añadir marcadores
      if (ofertas && ofertas.length > 0) {
        const bounds = [];

        ofertas.forEach((oferta) => {
          const marker = leaflet.marker([oferta.lat, oferta.lng]).addTo(mapa);
          bounds.push([oferta.lat, oferta.lng]);

          marker.bindPopup(`
            <div class="p-2">
              <h4 class="font-semibold text-sm">${oferta.titulo}</h4>
              <p class="text-xs text-gray-600 mt-1">${oferta.empresa}</p>
              <a href="/oferta/${oferta.id}" class="text-blue-600 text-xs mt-2 inline-block hover:underline">
                Ver detalles →
              </a>
            </div>
          `);
        });

        // Ajustar vista para mostrar todos los marcadores
        if (bounds.length > 0) {
          mapa.fitBounds(bounds, { padding: [50, 50] });
        }
      }
    });
  }
</script>
