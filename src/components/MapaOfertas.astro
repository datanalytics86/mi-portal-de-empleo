---
/**
 * Componente MapaOfertas
 *
 * Mapa interactivo con Leaflet que muestra ofertas de trabajo georeferenciadas
 * Basado en SPECIFICATIONS.md secci√≥n 12
 */

interface Oferta {
  id: string;
  titulo: string;
  empresa: string;
  comuna: string;
  lat: number;
  lng: number;
}

interface Props {
  ofertas: Oferta[];
  centerLat?: number;
  centerLng?: number;
  zoom?: number;
}

const {
  ofertas,
  centerLat = -33.4489,  // Santiago de Chile
  centerLng = -70.6693,
  zoom = 12
} = Astro.props;

// Generar ID √∫nico para cada instancia del mapa
const mapId = `mapa-${Math.random().toString(36).substring(2, 9)}`;
---

<!-- Cargar Leaflet JS desde CDN -->
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Cargar Leaflet MarkerCluster JS desde CDN -->
<script is:inline src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<div id={mapId} class="h-[400px] md:h-[500px] rounded-lg shadow-sm border border-border"></div>

<script define:vars={{ ofertas, centerLat, centerLng, zoom, mapId }} is:inline>
  // Esperar a que Leaflet y MarkerCluster est√©n cargados
  function initMap() {
    if (typeof L === 'undefined' || typeof L.markerClusterGroup === 'undefined') {
      setTimeout(initMap, 100);
      return;
    }

    try {
      // Inicializar mapa
      const mapa = L.map(mapId).setView([centerLat, centerLng], zoom);

      // Agregar tiles de OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 5
      }).addTo(mapa);

      // Crear grupo de clustering
      const markersCluster = L.markerClusterGroup({
        maxClusterRadius: 80,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 15
      });

      // Agregar marcadores al cluster
      const markers = [];
      ofertas.forEach(function(oferta) {
        const marker = L.marker([oferta.lat, oferta.lng]);

        // Popup con informaci√≥n de la oferta
        const popupContent =
          '<div class="p-2 min-w-[200px]">' +
            '<h4 class="font-semibold text-base text-gray-900 mb-1">' + oferta.titulo + '</h4>' +
            '<p class="text-sm text-gray-600 mb-1">' + oferta.empresa + '</p>' +
            '<p class="text-xs text-gray-500 mb-2">üìç ' + oferta.comuna + '</p>' +
            '<a href="/oferta/' + oferta.id + '" class="inline-block text-sm text-blue-600 hover:text-blue-800 font-medium transition">' +
              'Ver detalles ‚Üí' +
            '</a>' +
          '</div>';

        marker.bindPopup(popupContent);
        markers.push(marker);
        markersCluster.addLayer(marker);
      });

      // Agregar el cluster al mapa
      mapa.addLayer(markersCluster);

      // Ajustar vista para mostrar todos los marcadores
      if (markers.length > 0 && ofertas.length > 1) {
        // Usar los bounds del cluster
        const bounds = markersCluster.getBounds();
        if (bounds.isValid()) {
          mapa.fitBounds(bounds.pad(0.1));
        }
      }

      // Invalidar tama√±o del mapa despu√©s de cargar
      setTimeout(function() {
        mapa.invalidateSize();
      }, 100);
    } catch (error) {
      console.error('Error inicializando mapa:', error);
    }
  }

  // Iniciar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
</script>

<style>
  /* Estilos adicionales para el mapa */
  [id^="mapa-"] {
    z-index: 1;
    width: 100%;
  }

  /* Personalizar popup de Leaflet */
  :global(.leaflet-popup-content-wrapper) {
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  :global(.leaflet-popup-tip) {
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
  }

  /* Asegurar que controles de Leaflet sean visibles */
  :global(.leaflet-control-zoom) {
    border: 2px solid rgba(0,0,0,0.2);
  }

  :global(.leaflet-bar a) {
    background-color: #fff;
    color: #000;
  }

  /* Personalizar clusters */
  :global(.marker-cluster-small) {
    background-color: rgba(66, 153, 225, 0.6);
  }

  :global(.marker-cluster-small div) {
    background-color: rgba(66, 153, 225, 0.9);
    color: white;
    font-weight: 600;
  }

  :global(.marker-cluster-medium) {
    background-color: rgba(237, 137, 54, 0.6);
  }

  :global(.marker-cluster-medium div) {
    background-color: rgba(237, 137, 54, 0.9);
    color: white;
    font-weight: 600;
  }

  :global(.marker-cluster-large) {
    background-color: rgba(220, 38, 38, 0.6);
  }

  :global(.marker-cluster-large div) {
    background-color: rgba(220, 38, 38, 0.9);
    color: white;
    font-weight: 600;
  }

  /* Animaci√≥n suave en clusters */
  :global(.marker-cluster) {
    transition: transform 0.2s ease;
  }

  :global(.marker-cluster:hover) {
    transform: scale(1.1);
  }
</style>
