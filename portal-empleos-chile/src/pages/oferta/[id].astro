---
/**
 * Página de Detalle de Oferta
 *
 * Muestra información completa de la oferta y formulario de postulación
 * Basado en SPECIFICATIONS.md sección 5.1
 */

import Layout from '../../layouts/Layout.astro';
import MapaOfertas from '../../components/MapaOfertas.astro';
import FormularioPostulacion from '../../components/FormularioPostulacion.astro';
import { supabase } from '../../lib/supabase';
import { findComuna } from '../../lib/comunas';

// Obtener ID de la oferta desde params
const { id } = Astro.params;

// Validar que ID es un UUID válido
const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
if (!id || !uuidRegex.test(id)) {
  return Astro.redirect('/404');
}

// Fetch oferta desde Supabase
const { data: oferta, error } = await supabase
  .from('ofertas')
  .select('*')
  .eq('id', id)
  .eq('activa', true) // Solo ofertas activas
  .single();

// Si no existe o error, redirigir a 404
if (error || !oferta) {
  console.error('[Oferta] No encontrada o inactiva:', id, error);
  return Astro.redirect('/404');
}

// Obtener coordenadas de la comuna
const comuna = findComuna(oferta.comuna);
const lat = comuna?.lat || -33.4489;
const lng = comuna?.lng || -70.6693;

// Preparar datos para el mapa
const ofertaParaMapa = {
  id: oferta.id,
  titulo: oferta.titulo,
  empresa: oferta.empresa,
  comuna: oferta.comuna,
  lat,
  lng,
};

// Calcular fecha relativa
function getRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return 'Publicado hace un momento';
  if (diffInSeconds < 3600) return `Publicado hace ${Math.floor(diffInSeconds / 60)} minutos`;
  if (diffInSeconds < 86400) return `Publicado hace ${Math.floor(diffInSeconds / 3600)} horas`;
  if (diffInSeconds < 604800) return `Publicado hace ${Math.floor(diffInSeconds / 86400)} días`;
  if (diffInSeconds < 2592000) return `Publicado hace ${Math.floor(diffInSeconds / 604800)} semanas`;
  return `Publicado hace ${Math.floor(diffInSeconds / 2592000)} meses`;
}

const fechaRelativa = getRelativeTime(oferta.created_at);

// Fecha formateada
const fechaPublicacion = new Date(oferta.created_at).toLocaleDateString('es-CL', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Colores para badges
const tipoJornadaStyles: Record<string, string> = {
  'Full-time': 'bg-blue-50 text-blue-700 border-blue-200',
  'Part-time': 'bg-green-50 text-green-700 border-green-200',
  'Freelance': 'bg-purple-50 text-purple-700 border-purple-200',
  'Práctica': 'bg-orange-50 text-orange-700 border-orange-200'
};

const badgeStyle = tipoJornadaStyles[oferta.tipo_jornada] || 'bg-gray-50 text-gray-700 border-gray-200';

// Título para SEO
const pageTitle = `${oferta.titulo} - ${oferta.empresa} | Portal de Empleos Chile`;
const pageDescription = `${oferta.descripcion.substring(0, 155)}...`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 md:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center gap-2 text-text-secondary">
        <li>
          <a href="/" class="hover:text-accent transition">
            Inicio
          </a>
        </li>
        <li>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-4 h-4"
          >
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </li>
        <li class="text-text-primary font-medium truncate max-w-xs">
          {oferta.titulo}
        </li>
      </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Columna principal (2/3) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Header de la oferta -->
        <div class="bg-white rounded-lg shadow-sm border border-border p-6 md:p-8">
          <div class="mb-4">
            <span class={`inline-block px-3 py-1 ${badgeStyle} rounded-full text-sm font-medium border`}>
              {oferta.tipo_jornada}
            </span>
          </div>

          <h1 class="text-3xl md:text-4xl font-bold text-text-primary mb-3">
            {oferta.titulo}
          </h1>

          <p class="text-xl text-text-secondary mb-4">
            {oferta.empresa}
          </p>

          <div class="flex flex-wrap items-center gap-4 text-text-secondary">
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-5 h-5"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              <span>{oferta.comuna}</span>
            </div>

            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-5 h-5"
              >
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              <span>{fechaRelativa}</span>
            </div>

            {oferta.categoria && (
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="w-5 h-5"
                >
                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                </svg>
                <span>{oferta.categoria}</span>
              </div>
            )}
          </div>
        </div>

        <!-- Descripción -->
        <div class="bg-white rounded-lg shadow-sm border border-border p-6 md:p-8">
          <h2 class="text-2xl font-semibold text-text-primary mb-4">
            Descripción del puesto
          </h2>
          <div class="prose prose-lg max-w-none text-text-secondary leading-relaxed">
            <p class="whitespace-pre-line">
              {oferta.descripcion}
            </p>
          </div>
        </div>

        <!-- Mapa de ubicación -->
        <div class="bg-white rounded-lg shadow-sm border border-border p-6 md:p-8">
          <h2 class="text-2xl font-semibold text-text-primary mb-4">
            Ubicación
          </h2>
          <div class="rounded-lg overflow-hidden">
            <MapaOfertas
              ofertas={[ofertaParaMapa]}
              centerLat={lat}
              centerLng={lng}
              zoom={14}
            />
          </div>
          <p class="text-sm text-text-secondary mt-3">
            📍 {oferta.comuna}, Chile
          </p>
        </div>

        <!-- Información adicional -->
        <div class="bg-surface rounded-lg border border-border p-6">
          <h3 class="text-lg font-semibold text-text-primary mb-3">
            Información adicional
          </h3>
          <dl class="space-y-2 text-sm">
            <div class="flex justify-between">
              <dt class="text-text-secondary">Publicado:</dt>
              <dd class="text-text-primary font-medium">{fechaPublicacion}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-text-secondary">Tipo de jornada:</dt>
              <dd class="text-text-primary font-medium">{oferta.tipo_jornada}</dd>
            </div>
            {oferta.categoria && (
              <div class="flex justify-between">
                <dt class="text-text-secondary">Categoría:</dt>
                <dd class="text-text-primary font-medium">{oferta.categoria}</dd>
              </div>
            )}
          </dl>
        </div>
      </div>

      <!-- Sidebar (1/3) -->
      <div class="lg:col-span-1">
        <!-- Sticky container -->
        <div class="lg:sticky lg:top-24">
          <FormularioPostulacion
            ofertaId={oferta.id}
            titulo={oferta.titulo}
            empresa={oferta.empresa}
          />

          <!-- Botón volver -->
          <div class="mt-6 text-center">
            <a
              href="/"
              class="inline-flex items-center gap-2 text-accent hover:text-accent-hover transition text-sm font-medium"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-4 h-4"
              >
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
              </svg>
              Ver todas las ofertas
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Estilos para whitespace-pre-line */
  .whitespace-pre-line {
    white-space: pre-line;
  }

  /* Sticky sidebar con espacio superior */
  @media (min-width: 1024px) {
    .lg\:sticky {
      position: sticky;
      top: 6rem; /* 24 = 96px = top-24 */
    }
  }
</style>
